import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Testing/Framework/Audit" tags={['phase-1-complete']} />

# Testing Strategy Audit Log
<div style={{display: 'inline-block', padding: '4px 12px', background: '#d3f9d8', color: '#2b8a3e', borderRadius: '16px', fontWeight: 'bold', marginBottom: '16px'}}>✅ Phase 1 Complete</div>

This document tracks the progress and effectiveness of the GenAI-powered testing strategy over time. Each entry represents a significant iteration or application of the strategy to a specific feature set.

---

## Milestone: Decorator Matrix Phase 1 Complete

**Date:** October 10, 2025

### Summary
Phase 1 (compile-only) is complete for all decorators with a no-drift, rule-driven workflow:
- Unified per-decorator folders: `@Decorator.mdx`, `rules.json`, `coverage.js`, `generate-components.js`, `coverage-data.json`, `coverage-overlay.json`.
- Shared docs UX via `RulesAtAGlance.jsx` (supports `modeLabel` and conditional bullets).
- Single generate flow (coverage → generate → coverage) with verify guard to enforce parity, grouping, and exclusivity.
- Storybook Overview imports updated to read per-decorator `coverage-data.json`.

### Decorators migrated
- Component, State, Prop, Event, Listen, Method

### Coverage status (compile-only)
- Component: 192/192 (100%)
- Prop: 24/24 (100%)
- Event: 8/8 (100%)
- Listen: 44/44 (100%)
- Method: 8/8 (100%, constrained to Promise-returning/async variants)
- State: 12/12 (100%)
- Total generated components: 288

### Verify guard and overlays
- `verify-matrix.js` now supports `--decorator=component|state|prop|event|listen|method`.
- Validates: coverage parity, `.tsx` file count alignment, grouping by modes, and optional exclusivity checks.
- Builds `coverage-overlay.json` for each decorator by scanning WDIO tests to surface `tested`/`testedBy` in docs.
- Listen coverage scan is scoped to `test/wdio/listen/matrix/**` to avoid legacy noise; DATA_PATH fixed.
- Method overlay/groups align with returns-based grouping; generator cleans invalid non-async void/value files.

### Scripts and workflow
- `.ai/testing/package.json` adds: `component:*`, `state:*`, `prop:*`, `event:*`, `listen:*`, `method:*` generate and verify shortcuts.
- Aggregate: `generate-components` runs all decorator loops; `refresh-coverage-matrix` invokes all coverage scripts.
- `run-all-coverage.js` includes Component, Prop, Event, Listen, Method, State.

### Docs updates
- Standardized sections per decorator (Decorator Properties, Rules, Generated Components, Grouping, Test Cases).
- `@State.mdx` cleanups and labels; `@Prop.mdx`, `@Event.mdx`, `@Listen.mdx`, `@Method.mdx` aligned to shared UX.

### Notable fixes
- Event: regenerated matrix under `test/wdio/event/matrix/<bubbles|no-bubbles>/` with WDIO test asserting in-component counter.
- Listen: generated full matrix grouped by `target`; overlay built; compile coverage at 100%.
- Method: constrained to allowed permutations (async or explicit Promise); cleaned invalid files; grouping by `returns`.

### Next (Phase 2: behavioral tests)
- Reuse WDIO tests across generated components for Listen and Method; mark tested status in overlays.
- Optionally add JSON Schema validation for `rules.json` and CI automation to enforce no-drift (refresh + verify-all).

---

# Audit Log: GenAI Testing Loop Improvements

## Manual Verification of Coverage Matrix

A key step in the testing loop is manual verification of the coverage matrix. After generating components and tests for all decorator permutations, manually change some decorator options (e.g., target, capture) in component files and re-run the coverage script. Confirm that the coverage report updates to reflect these changes. This ensures the coverage script accurately detects permutations and the matrix is reliable.

**Best Practice:**
- Always perform manual verification after reaching 100% coverage.
- Document any issues or false positives found during this step.
- Update the audit log and documentation to reflect improvements.

---

## Iteration: `@Component` — Rule‑driven matrix, generator, and verify guard

**Date:** September 14, 2025

### Summary
This iteration went well beyond expectations. GPT‑5 proposed and implemented a rule‑driven approach that materially improved speed and reliability:
- Authored a dedicated generator script for matrix components (10x+ faster end‑to‑end loop).
- Extracted human‑readable rules into a JSON file as the single source of truth.
- Added a verify guard script to enforce parity, grouping, and exclusivity, with a probe to validate rule‑driven growth.

### Key Changes
- Rules as source of truth
  - `Component/rules.json`: options schema, exclusivity groups, modes (grouping), emit naming/assets.
- Coverage refactor
  - `Component/coverage.js`: builds permutation space from rules (cartesian + exclusivity), validates covered permutations via rules, records relative file paths; supports env override `COMPONENT_RULES_PATH` for probes.
- Generator integration
  - `Component/generate-components.js`: derives names from `rules.emit.naming`, groups files via `rules.modes` (shadow/scoped/light), emits exactly one style prop per file from `rules.emit.assets`.
- Verify guard
  - `verify-matrix.js`: re‑runs coverage; asserts covered === total; asserts `.tsx` parity under `test/wdio/component-decorator/**`; validates exclusivity/groups using recorded files; optional probe removing the “encapsulation” group to confirm total permutations increase; portable (no shell dependency, direct Node invocation).
- Scripts/docs
  - `.ai/testing/package.json`: added `component:*` and `state:*` shortcuts, including `component:verify-matrix` and `state:verify-matrix`.
  - Quickstart updated to verify before build and document the recovery loop (tweak rules → coverage‑loop → verify → build → tests).
  - Storybook nav updated to surface Quickstart.

### Impact
- Speed: Loop execution improved by an estimated 10x+ due to automated generation and a clean verify step.
- Reliability: Exclusivity and grouping are now enforced automatically; parity guard prevents drift; probe confirms rules genuinely drive permutation space.

### Metrics
- Coverage: 192/192 (100.0%).
- Probe: Removing the “encapsulation” exclusivity increased total permutations from 192 → 216 (as expected), without generating files.
- Parity: `.tsx` count under `test/wdio/component-decorator/**` equals the covered permutations (192) recorded in `Testing/Decorators/Component/coverage-data.json`.

### Workflow Update
- Recommended order: coverage‑loop → verify‑matrix → build → tests.
- On compiler errors after generation: tweak rules → re‑run coverage‑loop → verify‑matrix → build → tests.

### Lessons Learned
- Centralizing rules enables both humans and automation to reason about validity and growth.
- Recording file paths in coverage enables downstream structural checks (grouping by render mode).
- Avoid shell dependencies for portability; prefer `execFileSync(process.execPath, ...)`.
- A small, deterministic verify guard prevents slow drift and keeps contributors aligned.

---

// Remaining content unchanged
