import rules from './rules.json';
import { Meta } from '@storybook/addon-docs/blocks';
import data from './coverage-data.json';
import overlay from './coverage-overlay.json';
import React, { useMemo, useState } from 'react';
import RulesAtAGlance from '../_shared/RulesAtAGlance.jsx';

<Meta title="Testing/Decorators/@Method"/>

# @Method Decorator

The `@Method` decorator exposes public instance methods on a Stencil component.

## Decorator Properties

- returns: void | value | promise
- async: marks the method async (affects return type when returning a promise)
- args: none | one

## Rules (at a glance)
<RulesAtAGlance rules={rules} sourcePath="./rules.json" modeLabel="Return kind" />

## Generated Components

<div>
  <strong>Generated Components:</strong> {data.coverage.covered} of {data.coverage.total} generated (
  <strong>{data.coverage.percent}%</strong>)
</div>

<p style={{ marginTop: 8 }}>
  One row per unique combination of <code>returns</code> × <code>async</code> × <code>args</code>.
  The “Tested / Test Cases” column is populated in Phase 2.
</p>

export const GeneratedComponentsTable = () => {
  const [expanded, setExpanded] = useState(false);

  const rows = useMemo(() => {
    const items = overlay.items || [];
    return (data.coveredPermutations || []).map((p, i) => {
      const [returns, async, args] = p.options || [];
      const key = `${returns}|${async}|${args}`;
      const oi = items.find(x => x.optionsKey === key) || {};
      return { index: i, returns, async, args, tested: !!oi.tested, tests: oi.testedBy || [] };
    });
  }, []);

  const total = rows.length;

  const renderTable = (rowsToRender) => (
    <div style={{ maxWidth: '100%', width: '100%', background: '#fff' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse', tableLayout: 'fixed' }}>
        <colgroup>
          <col style={{ width: '30%' }} />
          <col style={{ width: '20%' }} />
          <col style={{ width: '20%' }} />
          <col style={{ width: '10%' }} />
          <col style={{ width: '20%' }} />
        </colgroup>
        <thead>
          <tr>
            <th>returns</th>
            <th>async</th>
            <th>args</th>
            <th style={{ textAlign: 'center' }}>Tested</th>
            <th>Test Cases</th>
          </tr>
        </thead>
        <tbody>
          {rowsToRender.map((r) => (
            <tr key={r.index} style={{ background: r.tested ? '#fbfffb' : '#fff' }}>
              <td>{r.returns}</td>
              <td>{r.async}</td>
              <td>{r.args}</td>
              <td style={{ textAlign: 'center' }}>
                {r.tested ? <span style={{ color: 'green' }}>✔</span> : <span style={{ color: '#999' }}>—</span>}
              </td>
              <td>
                {r.tests.length ? (
                  <ul style={{ margin: 0, paddingLeft: 16 }}>
                    {r.tests.map((t, k) => (
                      <li key={k}>{t}</li>
                    ))}
                  </ul>
                ) : (
                  <em>—</em>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );

  if (!expanded) {
    const preview = rows.slice(0, 3);
    return (
      <div style={{ position: 'relative' }}>
        {renderTable(preview)}
        {total > 3 && (
          <>
            <div style={{ position: 'absolute', left: 0, right: 0, bottom: 40, height: 48, background: 'linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 90%)', pointerEvents: 'none' }} />
            <div style={{ display: 'flex', justifyContent: 'center', marginTop: -8 }}>
              <button onClick={() => setExpanded(true)} style={{ padding: '6px 12px', border: '1px solid #ddd', background: '#f8f8f8', borderRadius: 4, cursor: 'pointer', fontSize: 12 }} aria-label={`Show all ${total} components`}>
                Show all {total} components
              </button>
            </div>
          </>
        )}
      </div>
    );
  }

  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 8 }}>
        <button onClick={() => setExpanded(false)} style={{ padding: '6px 12px', border: '1px solid #ddd', background: '#f8f8f8', borderRadius: 4, cursor: 'pointer', fontSize: 12 }} aria-label="Collapse components table">
          Collapse table
        </button>
      </div>
      {renderTable(rows)}
    </div>
  );
};

<GeneratedComponentsTable />

## Component Grouping

Components are grouped by return kind under `test/wdio/method/matrix/<void|value|promise>/`.

## Test Cases

<div style={{ maxWidth: '100%', width: '100%', background: '#fff' }}>
  <table style={{ width: '100%', borderCollapse: 'collapse' }}>
    <colgroup>
      <col style={{ width: '35%' }} />
      <col style={{ width: '15%' }} />
      <col style={{ width: '25%' }} />
      <col style={{ width: '25%' }} />
    </colgroup>
    <thead>
      <tr style={{ background: 'rgba(242, 242, 242, 1)' }}>
        <th style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'left' }}>Scenario</th>
        <th style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center' }}>Status</th>
        <th style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'left' }}>Test File(s)</th>
        <th style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'left' }}>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Promise components render and expose a <code>run()</code> API that returns a promise.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: 'green' }}>Implemented</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>
          <code>test/wdio/method/tests/method-promise-api.tests.tsx</code>
        </td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Confirms public method availability on all async/non-async promise variants.</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Promise components update <code>#counter</code> only after the promise resolves.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: 'green' }}>Implemented</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>
          <code>test/wdio/method/tests/method-promise-api.tests.tsx</code>
        </td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Verifies resolved values propagate to the DOM across args: none | one.</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Promise rejection handling.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: '#999' }}>Planned</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>—</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Verify error UI/state when <code>run()</code> rejects and ensure success content does not render prematurely.</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Pending-state UX during long-running promises.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: '#999' }}>Planned</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>—</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Assert buttons/spinners reflect pending work and no DOM change occurs until resolution.</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Argument-driven value flow (single-argument variants).</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: '#999' }}>Planned</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>—</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Ensure argument values impact resolved output (e.g., counter reflects passed value).</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Re-entrancy and concurrency safeguards.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: '#999' }}>Planned</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>—</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Define expected behavior for rapid/overlapping invocations and assert DOM consistency.</td>
      </tr>
      <tr>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Timing and cleanup validations.</td>
        <td style={{ padding: '8px', border: '1px solid #ddd', textAlign: 'center', color: '#999' }}>Planned</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>—</td>
        <td style={{ padding: '8px', border: '1px solid #ddd' }}>Confirm no residual pending state across sequential calls and that microtask timing is respected.</td>
      </tr>
    </tbody>
  </table>
</div>
