import rules from './rules.json';
import { Meta } from '@storybook/addon-docs/blocks';
import data from './coverage-data.json';
import overlay from './coverage-overlay.json';
import React, { useMemo, useState } from 'react';
import RulesAtAGlance from '../_shared/RulesAtAGlance.jsx';

<Meta title="Testing/Decorators/@Prop"/>

# @Prop Decorator

The `@Prop` decorator exposes public properties on components. This page documents the decorator properties, rules, generated components, component grouping, and test cases summary.

## Decorator Properties

- Type: `@Prop` supports common types, including `string`, `number`, `boolean`, `Array`, `Object`, and `Set`.
- reflect: when true, reflects the value to a corresponding attribute.
- mutable: when true, allows internal mutation of the prop.

## Rules (at a glance)
<RulesAtAGlance rules={rules} sourcePath="./rules.json" modeLabel="Prop type" />

## Generated Components

<div>
  <strong>Generated Components:</strong> {data.coverage.covered} of {data.coverage.total} generated (
  <strong>{data.coverage.percent}%</strong>)
</div>

<p style={{ marginTop: 8 }}>
  One row per unique combination of <code>type</code> × <code>reflect</code> × <code>mutable</code>. If a combo fails to compile, capture it in <code>rules.json</code> and regenerate. The “Tested / Test Cases” column is populated in Phase 2.
</p>

export const GeneratedComponentsTable = () => {
  const [expanded, setExpanded] = useState(false);

  const rows = useMemo(() => {
    const items = overlay.items || [];
    return (data.coveredPermutations || []).map((p, i) => {
      const [type, reflect, mutable] = p.options || [];
      const key = `${type}|${reflect}|${mutable}`;
      const oi = items.find(x => x.optionsKey === key || x.tag?.includes(type)) || {};
      return {
        index: i,
        type,
        reflect,
        mutable,
        tested: !!oi.tested,
        tests: oi.testedBy || [],
      };
    });
  }, []);

  const total = rows.length;

  const renderTable = (rowsToRender) => (
    <div style={{ maxWidth: '100%', width: '100%', background: '#fff' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse', tableLayout: 'fixed' }}>
        <colgroup>
          <col style={{ width: '22%' }} />
          <col style={{ width: '18%' }} />
          <col style={{ width: '18%' }} />
          <col style={{ width: '12%' }} />
          <col style={{ width: '30%' }} />
        </colgroup>
        <thead>
          <tr>
            <th>Type</th>
            <th>reflect</th>
            <th>mutable</th>
            <th style={{ textAlign: 'center' }}>Tested</th>
            <th>Test Cases</th>
          </tr>
        </thead>
        <tbody>
          {rowsToRender.map((r) => (
            <tr key={r.index} style={{ background: r.tested ? '#fbfffb' : '#fff' }}>
              <td>{r.type}</td>
              <td>{r.reflect}</td>
              <td>{r.mutable}</td>
              <td style={{ textAlign: 'center' }}>
                {r.tested ? <span style={{ color: 'green' }}>✔</span> : <span style={{ color: '#999' }}>—</span>}
              </td>
              <td>
                {r.tests.length ? (
                  <ul style={{ margin: 0, paddingLeft: 16 }}>
                    {r.tests.map((t, k) => (
                      <li key={k}>{t}</li>
                    ))}
                  </ul>
                ) : (
                  <em>—</em>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );

  if (!expanded) {
    const preview = rows.slice(0, 3);
    return (
      <div style={{ position: 'relative' }}>
        {renderTable(preview)}
        {total > 3 && (
          <>
            <div
              style={{
                position: 'absolute',
                left: 0,
                right: 0,
                bottom: 40,
                height: 48,
                background: 'linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 90%)',
                pointerEvents: 'none',
              }}
            />
            <div style={{ display: 'flex', justifyContent: 'center', marginTop: -8 }}>
              <button
                onClick={() => setExpanded(true)}
                style={{
                  padding: '6px 12px',
                  border: '1px solid #ddd',
                  background: '#f8f8f8',
                  borderRadius: 4,
                  cursor: 'pointer',
                  fontSize: 12,
                }}
                aria-label={`Show all ${total} components`}
              >
                Show all {total} components
              </button>
            </div>
          </>
        )}
      </div>
    );
  }

  return (
    <div>
      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 8 }}>
        <button
          onClick={() => setExpanded(false)}
          style={{
            padding: '6px 12px',
            border: '1px solid #ddd',
            background: '#f8f8f8',
            borderRadius: 4,
            cursor: 'pointer',
            fontSize: 12,
          }}
          aria-label="Collapse components table"
        >
          Collapse table
        </button>
      </div>
      {renderTable(rows)}
    </div>
  );
};

<GeneratedComponentsTable />

## Component Grouping

Components are grouped by prop type under `test/wdio/prop/matrix/<type>/`. The spec files live under `test/wdio/prop/tests`.

## Test Cases

- Phase 2 placeholder: tests will be propagated across generated components and recorded in `coverage-overlay.json`.
